"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SegmentEncoder=void 0;const Base64Url_js_1=require("./Base64Url.js"),BitLength_js_1=require("./BitLength.js"),index_js_1=require("./field/index.js"),index_js_2=require("./sequence/index.js"),index_js_3=require("../errors/index.js"),Fields_js_1=require("../model/Fields.js"),index_js_4=require("../model/index.js");class SegmentEncoder{static encode(e,s){let n;try{n=this.fieldSequence[String(e.version)][s]}catch(n){throw new index_js_3.EncodingError(`Unable to encode version: ${e.version}, segment: ${s}`)}let i="";s!==index_js_4.Segment.CORE&&(i=index_js_1.IntEncoder.encode(index_js_4.SegmentIDs.KEY_TO_ID[s],BitLength_js_1.BitLength.segmentType));const t=(0,index_js_1.FieldEncoderMap)();return n.forEach(n=>{const r=e[n],d=t[n];let o=BitLength_js_1.BitLength[n];void 0===o&&this.isPublisherCustom(n)&&(o=Number(e[Fields_js_1.Fields.numCustomPurposes]));try{i+=d.encode(r,o)}catch(e){throw new index_js_3.EncodingError(`Error encoding ${s}->${n}: ${e.message}`)}}),Base64Url_js_1.Base64Url.encode(i)}static decode(e,s,n){const i=Base64Url_js_1.Base64Url.decode(e);let t=0;n===index_js_4.Segment.CORE&&(s.version=index_js_1.IntEncoder.decode(i.substr(t,BitLength_js_1.BitLength[Fields_js_1.Fields.version]),BitLength_js_1.BitLength[Fields_js_1.Fields.version])),n!==index_js_4.Segment.CORE&&(t+=BitLength_js_1.BitLength.segmentType);const r=this.fieldSequence[String(s.version)][n],d=(0,index_js_1.FieldEncoderMap)();return r.forEach(e=>{const n=d[e];let r=BitLength_js_1.BitLength[e];if(void 0===r&&this.isPublisherCustom(e)&&(r=Number(s[Fields_js_1.Fields.numCustomPurposes])),0!==r){const d=i.substr(t,r);if(n===index_js_1.VendorVectorEncoder?s[e]=n.decode(d,s.version):s[e]=n.decode(d,r),Number.isInteger(r))t+=r;else{if(!Number.isInteger(s[e].bitLength))throw new index_js_3.DecodingError(e);t+=s[e].bitLength}}}),s}static isPublisherCustom(e){return 0===e.indexOf("publisherCustom")}}exports.SegmentEncoder=SegmentEncoder,SegmentEncoder.fieldSequence=new index_js_2.FieldSequence;