"use strict";var __awaiter=this&&this.__awaiter||function(e,s,t,r){return new(t||(t=Promise))((function(i,n){function o(e){try{h(r.next(e))}catch(e){n(e)}}function a(e){try{h(r.throw(e))}catch(e){n(e)}}function h(e){var s;e.done?i(e.value):(s=e.value,s instanceof t?s:new t((function(e){e(s)}))).then(o,a)}h((r=r.apply(e,s||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GVL=void 0;const Cloneable_js_1=require("./Cloneable.js"),index_js_1=require("./errors/index.js"),Json_js_1=require("./Json.js"),index_js_2=require("./model/index.js");class GVL extends Cloneable_js_1.Cloneable{constructor(e){super(),this.isReady_=!1,this.isLatest=!1;let s=GVL.baseUrl;if(this.lang_=GVL.DEFAULT_LANGUAGE,this.isVendorList(e))this.populate(e),this.readyPromise=Promise.resolve();else{if(!s)throw new index_js_1.GVLError("must specify GVL.baseUrl before loading GVL json");if(e>0){const t=e;GVL.CACHE.has(t)?(this.populate(GVL.CACHE.get(t)),this.readyPromise=Promise.resolve()):(s+=GVL.versionedFilename.replace("[VERSION]",String(t)),this.readyPromise=this.fetchJson(s))}else GVL.CACHE.has(GVL.LATEST_CACHE_KEY)?(this.populate(GVL.CACHE.get(GVL.LATEST_CACHE_KEY)),this.readyPromise=Promise.resolve()):(this.isLatest=!0,this.readyPromise=this.fetchJson(s+GVL.latestFilename))}}static set baseUrl(e){if(/^https?:\/\/vendorlist\.consensu\.org\//.test(e))throw new index_js_1.GVLError("Invalid baseUrl!  You may not pull directly from vendorlist.consensu.org and must provide your own cache");e.length>0&&"/"!==e[e.length-1]&&(e+="/"),this.baseUrl_=e}static get baseUrl(){return this.baseUrl_}static emptyLanguageCache(e){let s=!1;return void 0===e&&GVL.LANGUAGE_CACHE.size>0?(GVL.LANGUAGE_CACHE=new Map,s=!0):"string"==typeof e&&this.consentLanguages.has(e.toUpperCase())&&(GVL.LANGUAGE_CACHE.delete(e.toUpperCase()),s=!0),s}static emptyCache(e){let s=!1;return Number.isInteger(e)&&e>=0?(GVL.CACHE.delete(e),s=!0):void 0===e&&(GVL.CACHE=new Map,s=!0),s}cacheLanguage(){GVL.LANGUAGE_CACHE.has(this.lang_)||GVL.LANGUAGE_CACHE.set(this.lang_,{purposes:this.purposes,specialPurposes:this.specialPurposes,features:this.features,specialFeatures:this.specialFeatures,stacks:this.stacks})}fetchJson(e){return __awaiter(this,void 0,void 0,(function*(){try{this.populate(yield Json_js_1.Json.fetch(e))}catch(e){throw new index_js_1.GVLError(e.message)}}))}getJson(){return JSON.parse(JSON.stringify({gvlSpecificationVersion:this.gvlSpecificationVersion,vendorListVersion:this.vendorListVersion,tcfPolicyVersion:this.tcfPolicyVersion,lastUpdated:this.lastUpdated,purposes:this.purposes,specialPurposes:this.specialPurposes,features:this.features,specialFeatures:this.specialFeatures,stacks:this.stacks,vendors:this.fullVendorList}))}changeLanguage(e){return __awaiter(this,void 0,void 0,(function*(){const s=e.toUpperCase();if(!GVL.consentLanguages.has(s))throw new index_js_1.GVLError("unsupported language "+e);if(s!==this.lang_)if(this.lang_=s,GVL.LANGUAGE_CACHE.has(s)){const e=GVL.LANGUAGE_CACHE.get(s);for(const s in e)e.hasOwnProperty(s)&&(this[s]=e[s])}else{const s=GVL.baseUrl+GVL.languageFilename.replace("[LANG]",e);try{yield this.fetchJson(s),this.cacheLanguage()}catch(e){throw new index_js_1.GVLError("unable to load language: "+e.message)}}}))}get language(){return this.lang_}isVendorList(e){return void 0!==e&&void 0!==e.vendors}populate(e){this.purposes=e.purposes,this.specialPurposes=e.specialPurposes,this.features=e.features,this.specialFeatures=e.specialFeatures,this.stacks=e.stacks,this.isVendorList(e)&&(this.gvlSpecificationVersion=e.gvlSpecificationVersion,this.tcfPolicyVersion=e.tcfPolicyVersion,this.vendorListVersion=e.vendorListVersion,this.lastUpdated=e.lastUpdated,"string"==typeof this.lastUpdated&&(this.lastUpdated=new Date(this.lastUpdated)),this.vendors_=e.vendors,this.fullVendorList=e.vendors,this.mapVendors(),this.isReady_=!0,this.isLatest&&GVL.CACHE.set(GVL.LATEST_CACHE_KEY,this.getJson()),GVL.CACHE.has(this.vendorListVersion)||GVL.CACHE.set(this.vendorListVersion,this.getJson())),this.cacheLanguage()}mapVendors(e){this.byPurposeVendorMap={},this.bySpecialPurposeVendorMap={},this.byFeatureVendorMap={},this.bySpecialFeatureVendorMap={},Object.keys(this.purposes).forEach(e=>{this.byPurposeVendorMap[e]={legInt:new Set,consent:new Set,flexible:new Set}}),Object.keys(this.specialPurposes).forEach(e=>{this.bySpecialPurposeVendorMap[e]=new Set}),Object.keys(this.features).forEach(e=>{this.byFeatureVendorMap[e]=new Set}),Object.keys(this.specialFeatures).forEach(e=>{this.bySpecialFeatureVendorMap[e]=new Set}),Array.isArray(e)||(e=Object.keys(this.fullVendorList).map(e=>+e)),this.vendorIds=new Set(e),this.vendors_=e.reduce((e,s)=>{const t=this.vendors_[String(s)];return t&&void 0===t.deletedDate&&(t.purposes.forEach(e=>{this.byPurposeVendorMap[String(e)].consent.add(s)}),t.specialPurposes.forEach(e=>{this.bySpecialPurposeVendorMap[String(e)].add(s)}),t.legIntPurposes.forEach(e=>{this.byPurposeVendorMap[String(e)].legInt.add(s)}),t.flexiblePurposes&&t.flexiblePurposes.forEach(e=>{this.byPurposeVendorMap[String(e)].flexible.add(s)}),t.features.forEach(e=>{this.byFeatureVendorMap[String(e)].add(s)}),t.specialFeatures.forEach(e=>{this.bySpecialFeatureVendorMap[String(e)].add(s)}),e[s]=t),e},{})}getFilteredVendors(e,s,t,r){const i=e.charAt(0).toUpperCase()+e.slice(1);let n;const o={};return n="purpose"===e&&t?this["by"+i+"VendorMap"][String(s)][t]:this["by"+(r?"Special":"")+i+"VendorMap"][String(s)],n.forEach(e=>{o[String(e)]=this.vendors[String(e)]}),o}getVendorsWithConsentPurpose(e){return this.getFilteredVendors("purpose",e,"consent")}getVendorsWithLegIntPurpose(e){return this.getFilteredVendors("purpose",e,"legInt")}getVendorsWithFlexiblePurpose(e){return this.getFilteredVendors("purpose",e,"flexible")}getVendorsWithSpecialPurpose(e){return this.getFilteredVendors("purpose",e,void 0,!0)}getVendorsWithFeature(e){return this.getFilteredVendors("feature",e)}getVendorsWithSpecialFeature(e){return this.getFilteredVendors("feature",e,void 0,!0)}get vendors(){return this.vendors_}narrowVendorsTo(e){this.mapVendors(e)}get isReady(){return this.isReady_}clone(){const e=new GVL(this.getJson());return this.lang_!==GVL.DEFAULT_LANGUAGE&&e.changeLanguage(this.lang_),e}static isInstanceOf(e){return"object"==typeof e&&"function"==typeof e.narrowVendorsTo}}exports.GVL=GVL,GVL.LANGUAGE_CACHE=new Map,GVL.CACHE=new Map,GVL.LATEST_CACHE_KEY=0,GVL.DEFAULT_LANGUAGE="EN",GVL.consentLanguages=new index_js_2.ConsentLanguages,GVL.latestFilename="vendor-list.json",GVL.versionedFilename="archives/vendor-list-v[VERSION].json",GVL.languageFilename="purposes-[LANG].json";